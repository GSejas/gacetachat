[tox]
envlist = py39, py310, py311, lint, format, docs, smoke-test
isolated_build = true
skip_missing_interpreters = true

[testenv]
description = run unit tests
deps = 
    pytest>=7.0.0
    pytest-mock>=3.10.0
    pytest-cov>=4.0.0
    pytest-xvfb>=2.0.0
    requests-mock>=1.10.0
    sqlalchemy>=1.4.0
    fastapi>=0.95.0
    streamlit>=1.28.0
    openai>=1.0.0
    faiss-cpu>=1.7.0
    langchain>=0.1.0
    beautifulsoup4>=4.11.0
    python-multipart>=0.0.6
    pydantic>=2.0.0
    uvicorn>=0.20.0
setenv =
    PYTHONDONTWRITEBYTECODE = 1
    PYTHONPATH = {toxinidir}
    OPENAI_API_KEY = test-api-key
    DATABASE_URL = sqlite:///test.db
    TESTING = true
commands = 
    pytest {posargs:test/} -v --tb=short --cov=. --cov-report=term-missing --cov-report=html

[testenv:lint]
description = run linters
deps = 
    flake8>=6.0.0
    flake8-docstrings>=1.7.0
    flake8-import-order>=0.18.0
    mypy>=1.0.0
    bandit>=1.7.0
commands = 
    flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
    flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    mypy . --ignore-missing-imports --no-strict-optional
    bandit -r . -f json -o bandit-report.json

[testenv:format]
description = run code formatters
deps = 
    black>=23.0.0
    isort>=5.12.0
    autoflake>=2.0.0
commands = 
    autoflake --remove-all-unused-imports --recursive --remove-unused-variables --in-place .
    isort .
    black .

[testenv:format-check]
description = check code formatting
deps = 
    black>=23.0.0
    isort>=5.12.0
commands = 
    isort --check-only .
    black --check .

[testenv:docs]
description = build documentation
deps = 
    mkdocs>=1.5.0
    mkdocs-material>=9.0.0
    mkdocs-git-revision-date-localized-plugin>=1.2.0
    mkdocs-minify-plugin>=0.7.0
    mike>=1.1.0
commands = 
    mkdocs build --strict
    mkdocs serve --dev-addr=localhost:8001 --dirty

[testenv:docs-deploy]
description = deploy documentation
deps = 
    mkdocs>=1.5.0
    mkdocs-material>=9.0.0
    mkdocs-git-revision-date-localized-plugin>=1.2.0
    mkdocs-minify-plugin>=0.7.0
    mike>=1.1.0
commands = 
    mike deploy --push --update-aliases {posargs:latest}

[testenv:smoke-test]
description = run smoke tests to verify basic functionality
deps = 
    pytest>=7.0.0
    requests>=2.28.0
    streamlit>=1.28.0
    fastapi>=0.95.0
    uvicorn>=0.20.0
    psutil>=5.9.0
setenv =
    PYTHONPATH = {toxinidir}
    TESTING = true
    SMOKE_TEST = true
commands = 
    pytest test/smoke/ -v --tb=short -x

[testenv:security]
description = run security checks
deps = 
    bandit>=1.7.0
    safety>=2.3.0
    pip-audit>=2.6.0
commands = 
    bandit -r . -f txt -o bandit-security-report.txt
    safety check --json --output safety-report.json
    pip-audit --format=json --output=pip-audit-report.json

[testenv:performance]
description = run performance tests
deps = 
    pytest>=7.0.0
    pytest-benchmark>=4.0.0
    memory-profiler>=0.60.0
setenv =
    PYTHONPATH = {toxinidir}
commands = 
    pytest test/performance/ -v --benchmark-only --benchmark-json=benchmark-results.json

[testenv:integration]
description = run integration tests
deps = 
    {[testenv]deps}
    docker>=6.0.0
    testcontainers>=3.7.0
setenv =
    {[testenv]setenv}
    INTEGRATION_TEST = true
commands = 
    pytest test/integration/ -v --tb=short --maxfail=3

[testenv:clean]
description = clean up build artifacts
deps = 
allowlist_externals = 
    rm
    find
commands = 
    rm -rf .pytest_cache/
    rm -rf .coverage
    rm -rf htmlcov/
    rm -rf dist/
    rm -rf build/
    rm -rf *.egg-info/
    find . -type d -name __pycache__ -exec rm -rf {} +
    find . -type f -name "*.pyc" -delete

[flake8]
max-line-length = 127
extend-ignore = E203, W503, E501
exclude = 
    .git,
    __pycache__,
    .tox,
    .eggs,
    *.egg,
    build,
    dist,
    .venv,
    venv

[coverage:run]
source = .
omit = 
    */test/*
    */tests/*
    */.tox/*
    */.venv/*
    */venv/*
    setup.py
    conftest.py

[coverage:report]
exclude_lines =
    pragma: no cover
    def __repr__
    raise AssertionError
    raise NotImplementedError
    if __name__ == .__main__.:
    class .*\(Protocol\):
    @(abc\.)?abstractmethod
